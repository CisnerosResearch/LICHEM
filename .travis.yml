#Build testing for LICHEM

#NB: Currently the OSX build skips the documentation

#Email settings
# notifications:
#   email:
#     on_success: change
#     on_failure: always

#Compiler settings
language: cpp
compiler:
  - gcc
  - clang

#OS settings
sudo: required
dist: trusty
os:
  - linux
  - osx

#Install required packages
before_install:
  ### Linux options
  - if [ ${TRAVIS_OS_NAME} == linux ]; then sudo apt-get install -qq texlive; fi
  ## Find the missing library (Travis Ubuntu -L issue). Need -qq for all installs
  - if [ ${TRAVIS_OS_NAME} == linux ]; then sudo apt-get install -qq "${CC}" libiomp-dev; fi
  - if [ ${TRAVIS_OS_NAME} == linux ]; then sudo apt-get install -qq libiomp5; fi
  ## Remove space if Makefile has "CXX=g++" !
  - if [ ${TRAVIS_OS_NAME} == linux ]; then if [ ${CXX} == clang++ ]; then sed -i 's/CXX= /CXX=clan/g' Makefile; fi; fi
  - if [ ${TRAVIS_OS_NAME} == linux ]; then if [ ${CC} == clang ]; then sed -i 's/CC=/CC=clan/g' Makefile; fi; fi
  # Change flag for Linux C++
  # - if [ ${TRAVIS_OS_NAME} == linux ]; then if [ ${CXX} == clang++ ]; then sed -i 's/CXXFLAGS=/CXXFLAGS= -static -O3 -fopenmp=libiomp/g' Makefile; fi; fi
  # - if [ ${TRAVIS_OS_NAME} == linux ]; then if [ ${CC} == clang ]; then sed -i 's/CXXFLAGS=/CXXFLAGS= -static -O3 -fopenmp=libiomp /g' Makefile; fi; fi
  # - if [ ${TRAVIS_OS_NAME} == linux ]; then export LD_LIBRARY_PATH=$(if [[ $CXX == clang++ ]]; then echo -n '/usr/local/clang/lib'; fi); fi
  #
  - if [ ${TRAVIS_OS_NAME} == linux ]; then if [ ${CC} == clang ] || [ ${CXX} == clang++ ]; then sed -i 's/-fopenmp/-I\/usr\/lib\/gcc\/x86_64-linux-gnu\/7\/include -fopenmp -stdlib=libc++/g' Makefile; fi; fi
  ### OSX options
  - if [ ${TRAVIS_OS_NAME} == osx ]; then brew update; fi
  - if [ ${TRAVIS_OS_NAME} == osx ]; then if [ ${CXX} == clang++ ]; then sed -i "" 's/CXX= /CXX=clan/g' Makefile; fi; fi
  - if [ ${TRAVIS_OS_NAME} == osx ]; then if [ ${CC} == clang ]; then sed -i "" 's/CC=/CC=clan/g' Makefile; fi; fi
  - if [ ${TRAVIS_OS_NAME} == osx ]; then sed -i "" 's/-static//g' Makefile; fi
  - if [ ${TRAVIS_OS_NAME} == osx ]; then sed -i "" 's/-fopenmp//g' Makefile; fi
  - if [ ${TRAVIS_OS_NAME} == osx ]; then sed -i "" 's/SEDI=-i/SEDI=-i \"\"/g' Makefile; fi
  # Link to OpenMP library for clang
  # - export LD_LIBRARY_PATH=$(if [[ $CC == "clang" ]]; then echo -n '/usr/local/clang/lib'; fi)

script:
  - if [ ${TRAVIS_OS_NAME} == linux ]; then sudo ldconfig; fi
  - make install && make clean
  - if [ ${TRAVIS_OS_NAME} == linux ]; then apt-get moo; fi
